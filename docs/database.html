<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Database</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Gungnir</span> <span class="project-version">0.0.1-SNAPSHOT</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="README.html"><div class="inner"><span>Gungnir</span></div></a></li><li class="depth-1 "><a href="guide.html"><div class="inner"><span>Guide</span></div></a></li><li class="depth-1  current"><a href="database.html"><div class="inner"><span>Database</span></div></a></li><li class="depth-1 "><a href="migrations.html"><div class="inner"><span>Migrations</span></div></a></li><li class="depth-1 "><a href="model.html"><div class="inner"><span>Model</span></div></a></li><li class="depth-1 "><a href="changeset.html"><div class="inner"><span>Changeset</span></div></a></li><li class="depth-1 "><a href="query.html"><div class="inner"><span>Query</span></div></a></li><li class="depth-1 "><a href="ui.html"><div class="inner"><span>UI</span></div></a></li><li class="depth-1 "><a href="form.html"><div class="inner"><span>Form</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>gungnir</span></div></div></li><li class="depth-2 branch"><a href="gungnir.changeset.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>changeset</span></div></a></li><li class="depth-2"><a href="gungnir.database.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>database</span></div></a></li><li class="depth-3"><a href="gungnir.database.builder.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>builder</span></div></a></li><li class="depth-2 branch"><a href="gungnir.decode.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>decode</span></div></a></li><li class="depth-2 branch"><a href="gungnir.factory.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>factory</span></div></a></li><li class="depth-2 branch"><a href="gungnir.field.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>field</span></div></a></li><li class="depth-2 branch"><a href="gungnir.model.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>model</span></div></a></li><li class="depth-2 branch"><a href="gungnir.query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>query</span></div></a></li><li class="depth-2 branch"><a href="gungnir.record.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>record</span></div></a></li><li class="depth-2 branch"><a href="gungnir.spec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>spec</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></div></li><li class="depth-3"><a href="gungnir.util.malli.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>malli</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#database" name="database"></a>Database</h1>
<p>The <code>gungnir.database</code> namespace is responsible for managing the database connection. By default it uses the <a href="https://github.com/brettwooldridge/HikariCP">HikariCP</a> connection pool.</p>
<h2><a href="#establishing-a-connection" name="establishing-a-connection"></a>Establishing a connection</h2>
<p>Use the <code>gungnir.database/make-datasource!</code> function to establish a database connection. Generally you’d want your system state manager to manage this. E.g. Integrant, Component, Mount.</p>
<p>This function accepts any of the following arguments:</p>
<ul>
  <li><code>JDBC_DATABASE_URL</code> - The standard format used to create a database connection  in Java.</li>
  <li><code>DATABASE_URL</code> - The universal format used to create a database  connection. Used by services such as Heroku or Render.</li>
  <li><code>HikariCP</code> configuration - A <a href="https://github.com/tomekw/hikari-cp#configuration-options">HikariCP configuration  map</a>. Optionally  can also be given as a second argument, where the first argument is either a  <code>JDBC_DATABASE_URL</code> or <code>DATABASE_URL</code>.</li>
</ul>
<pre><code class="clojure">(gungnir.database/make-datasource!
  "jdbc:postgresql://localhost:5432/postgres?user=postgres&amp;password=postgres")
  
(gungnir.database/make-datasource!
  "postgres://postgres:postgres@localhost:5432/postgres")

(gungnir.database/make-datasource!
  {:adapter       "postgresql"
   :username      "postgres"
   :password      "postgres"
   :database-name "postgres"
   :server-name   "localhost"
   :port-number   5432})
</code></pre>
<p>Once established, the datasource will be stored in <code>gungnir.database/*database*</code>. If you’re using the Gungnir <a href="https://kwrooijen.github.io/gungnir/query.html">query</a> API you won’t have to access this yourself. Currently Gungnir only supports creating a single datasource.</p>
<h2><a href="#setting-a-custom-connection-pool" name="setting-a-custom-connection-pool"></a>Setting a custom connection pool</h2>
<p>A custom connection pool can also be set using the <code>gungnir.database/set-datasource!</code> function.</p>
<h2><a href="#exception-handling" name="exception-handling"></a>Exception handling</h2>
<p>When JDBC runs into an error it will raise an exception. This isn’t something that we want. Instead we would like to add errors to our changeset. This can be done using the <code>gungnir.database/exception-&gt;map</code> multimethod which takes a SQLException and matches by the Postgres error. It should then return a map with a field key, and a keyword representing the error.</p>
<p>In this example we catch the <code>"23505"</code> Postgres error.</p>
<p>This does a few things:</p>
<ul>
  <li>Parse the <code>SQLException</code> and find the related sql key</li>
  <li>Convert the sql key to a valid model record key</li>
  <li>Apply the <code>gungnir.model/format-error</code> multimethod in case of custom error messages</li>
  <li>Return <code>{record-key [error-message]}</code> (which by default will be <code>{record-key [:duplicate-key]}</code>)</li>
</ul>
<pre><code class="clojure">(defmethod exception-&gt;map "23505" [^SQLException e]
  (let [error (.getMessage e)
        sql-key (remove-quotes (re-find #"\".*\"" error))
        record-key (sql-key-&gt;keyword sql-key)]
    {record-key [(gungnir.model/format-error record-key :duplicate-key)]}))
</code></pre>
<p>In the event that an SQLException does not have an <code>exception-&gt;map</code> implementation, it will return <code>{:unknown [sql-exception-code]}</code>. The next step is to open an issue or create a pull request to Gungnir. You can implement the <code>exception-&gt;map</code> clause yourself as well.</p>
<h2><a href="#multiple-datasources" name="multiple-datasources"></a>Multiple datasources</h2>
<p>By default Gungnir has a global datasource. If you need to access multiple datasources we can use the <code>gungnir.factory</code> namespace. A local datasource will be bound to a specific namespace that you create. Inside of this namespace we will call <code>gungnir.factory/make-datasource-map!</code> and bind the resulting functions that are returned.</p>
<pre><code class="clojure">(ns my.datasource
  (:require
   [gungnir.factory]))

(def datasource-opts
  {:adapter       "postgresql"
   :username      "postgres"
   :password      "postgres"
   :database-name "postgres"
   :server-name   "localhost"
   :port-number   5432})

(let [datasource-map (gungnir.factory/make-datasource-map! datasource-opts)]
  (def close      (:close!-fn datasource-map))
  (def datasource (:datasource datasource-map))
  (def find!      (:find!-fn datasource-map))
  (def find-by!   (:find-by!-fn datasource-map))
  (def all!       (:all!-fn datasource-map))
  (def delete!    (:delete!-fn datasource-map))
  (def save!      (:save!-fn datasource-map)))
</code></pre>
<p>Now when you call <code>my.datasource/find!</code> which will query it’s local datasource instead of the global datasource with <code>q/find!</code>.</p>
<h2><a href="#logging" name="logging"></a>Logging</h2>
<p>Gungnir uses <a href="https://github.com/clojure/tools.logging">clojure/tools.logging</a> to log errors and debug information. You can plug in your own logging backend, whether that be timbre, slf4j, log4j, apache commons logging, etc.</p>
<p>In some error cases Gungnir might print out SQL or HoneySQL forms. These are always logged under the <code>gungnir.sql</code> ns at <code>:debug</code> level. To enable or disable these, see your logging backend configuration documentation.</p>
<hr />
<div class="footer-navigation">
<span>Previous: <a href="https://kwrooijen.github.io/gungnir/guide.html">guide</a></span>
<span>Next: <a href="https://kwrooijen.github.io/gungnir/migrations.html">migrations</a></span>
</div></div></div></div></body></html>