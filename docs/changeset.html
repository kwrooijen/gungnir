<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Changeset</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Gungnir</span> <span class="project-version">0.0.1-SNAPSHOT</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="README.html"><div class="inner"><span>Gungnir</span></div></a></li><li class="depth-1 "><a href="guide.html"><div class="inner"><span>Guide</span></div></a></li><li class="depth-1 "><a href="database.html"><div class="inner"><span>Database</span></div></a></li><li class="depth-1 "><a href="migrations.html"><div class="inner"><span>Migrations</span></div></a></li><li class="depth-1 "><a href="model.html"><div class="inner"><span>Model</span></div></a></li><li class="depth-1  current"><a href="changeset.html"><div class="inner"><span>Changeset</span></div></a></li><li class="depth-1 "><a href="query.html"><div class="inner"><span>Query</span></div></a></li><li class="depth-1 "><a href="ui.html"><div class="inner"><span>UI</span></div></a></li><li class="depth-1 "><a href="form.html"><div class="inner"><span>Form</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>gungnir</span></div></div></li><li class="depth-2 branch"><a href="gungnir.changeset.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>changeset</span></div></a></li><li class="depth-2"><a href="gungnir.database.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>database</span></div></a></li><li class="depth-3"><a href="gungnir.database.builder.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>builder</span></div></a></li><li class="depth-2 branch"><a href="gungnir.decode.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>decode</span></div></a></li><li class="depth-2 branch"><a href="gungnir.factory.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>factory</span></div></a></li><li class="depth-2 branch"><a href="gungnir.field.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>field</span></div></a></li><li class="depth-2 branch"><a href="gungnir.model.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>model</span></div></a></li><li class="depth-2 branch"><a href="gungnir.query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>query</span></div></a></li><li class="depth-2 branch"><a href="gungnir.record.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>record</span></div></a></li><li class="depth-2 branch"><a href="gungnir.spec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>spec</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></div></li><li class="depth-3"><a href="gungnir.util.malli.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>malli</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#changeset" name="changeset"></a>Changeset</h1>
<p>Changesets are responsible for writing data. They manage all data going <strong>towards</strong> the database. Changesets provide the following features.</p>
<ul>
  <li>Cast and filter data (internal / external) to valid model maps.</li>
  <li>Use namespaced keywords to determine which model to use.</li>
  <li>Validate your data, and aggregate / format any errors.</li>
  <li>View the changes that will be saved to the database.</li>
</ul>
<p><a href="https://kwrooijen.github.io/gungnir/model.html">Models</a> are the basis of your changesets. They determine what is and isn’t allowed to be stored in the database.</p>
<h2><a href="#structure-of-changesets" name="structure-of-changesets"></a>Structure of changesets</h2>
<p>Changesets are namespaced maps with the <code>:changeset</code> namespace. They hold the following information.</p>
<ul>
  <li>
  <p><code>:changeset/model</code> - The model that is being changed, e.g. <code>:user</code></p></li>
  <li>
  <p><code>:changeset/validators</code> - A vector of extra  <a href="https://kwrooijen.github.io/gungnir/model.html#model-validators">validators</a>  which should be applied to the resulting map.</p></li>
  <li>
  <p><code>:changeset/diff</code> - The differences that will be applied. If a new record is  being created, then all fields will be here. If a record is being updated,  only the differences will be stored here.</p></li>
  <li>
  <p><code>:changeset/origin</code> - In case that a record is being <strong>updated</strong>, the original  record will be stored here.</p></li>
  <li>
  <p><code>:changeset/transformed-origin</code> - In case that a record is being <strong>updated</strong>,  the original record will be stored here after it has undergone any  transformations.</p></li>
  <li>
  <p><code>:changeset/params</code> - The params that will be applied to the record, either  for inserting or updating.</p></li>
  <li>
  <p><code>:changeset/result</code> - The resulting record. If validated and approved, this  record will be stored in the database when executing the <code>gungnir.query/save!</code>  function.</p></li>
  <li>
  <p><code>:changeset/errors</code> - Any errors returned from the validation check. Errors  are represented by a map, where the key is the field (qualified-keyword) and  the value is a vector of error messages.</p></li>
</ul>
<h2><a href="#changeset-arguments" name="changeset-arguments"></a>Changeset arguments</h2>
<p>Changesets accept 3 different types of arguments.</p>
<ul>
  <li>
  <p><code>origin</code> - a map of the original record to be updated. If an <code>origin</code> map is  provided, and the <code>primary-key</code> is not nil, it will update the row on  <code>save!</code>. If no <code>origin</code> map is supplied, the changeset will create a new row on  <code>save!</code>.</p></li>
  <li>
  <p><code>params</code> - a map which will update the record with the fields  supplied. <code>params</code> must be cast to a proper model record  (qualified-keywords). </p></li>
  <li>
  <p><code>validators</code> - A vector of  <a href="https://kwrooijen.github.io/gungnir/model.html#model-validators">validators</a>  which will perform extra checks on the <code>:changeset/result</code> record.</p></li>
</ul>
<p>The order of arguments:</p>
<pre><code class="clojure">gungnir.changeset/create

([params])
([origin, params])
([params, validators])
([origin, params, validators])
</code></pre>
<h2><a href="#creating-a-changeset" name="creating-a-changeset"></a>Creating a changeset</h2>
<p>Creating a changeset is easy. Simply run the <code>gungnir.changeset/create</code> function, assuming we have a user <a href="https://kwrooijen.github.io/gungnir/model.html">model</a>.</p>
<pre><code class="clojure">;; New user

(gungnir.changeset/create {:user/email "user@test.com", :user/password "123456"})
;; =&gt; {:changeset/model :user
;; =&gt;  :changeset/params {:user/email "user@test.com", :user/password "123456"}
;; =&gt;  :changeset/errors nil
;; =&gt;  ,,,}

;; Updating email of existing user

(gungnir.changeset/create existing-user {:user/email "user@test.com"})
;; =&gt; {:changeset/diff {:user/email "user@test.com"}
;; =&gt;  ,,,}

;; Updating password of an existing user with extra validators

(gungnir.changeset/create existing-user 
                          {:user/password "123456",
                           :user/password-confirmation "12345"}
                          [:user/password-match?])
;; =&gt; {:changeset/errors {:user/password-confirmation ["Passwords don't match"]}
;; =&gt;  ,,,}
</code></pre>
<h2><a href="#casting-data" name="casting-data"></a>Casting data</h2>
<p>In the real world you’ll be working with external data, this data will most likely not be represented as namespaced maps. In order to convert data to the proper model maps you can use the <code>gungnir.changeset/cast</code> function.</p>
<pre><code class="clojure">(-&gt; {"email" "user@test.com"
     "password" "123456"
     "password_confirmation" "12345"
     "random_field" "this isn't a field defined in the model"}
    (gungnir.changeset/cast :user))
;; =&gt; {:user/email "user@test.com"
;; =&gt;  :user/password "123456"
;; =&gt;  :user/password-confirmation "12345"}
</code></pre>
<p>Using this function you’ll be able to filter out any unnecessary fields based on the model definition. Once the map has been cast, Gungnir will know which model to use when you create a changeset because of the namespaced keywords.</p>
<h2><a href="#saving-a-changeset" name="saving-a-changeset"></a>Saving a changeset</h2>
<p>Once all validation checks pass, you’ll be able to save a changeset to the database using the <code>gungnir.query/save!</code> function. This function will either insert or update the record depending if a <code>primary-key</code> is available. Gungnir knows which field is the primary-key because it is defined in the model. If you attempt to save the changeset when the <code>:changeset/errors</code> key is not <code>nil</code>, the <code>gungnir.query/save!</code> function will have <strong>no</strong> side effects and return the changeset as is.</p>
<p>If there are no errors, Gungnir will attempt to insert / update the record in question. Applying this change however can also result in errors (e.g. <code>UNIQUE
CONSTRAINT</code> error). When this happens the changeset will be returned with new errors supplied to the <code>:changeset/errors</code> key.</p>
<p>Here’s a real-world example on how this might look like using a Ring handler.</p>
<pre><code class="clojure">(defn attempt-register-user [request]
  (-&gt; (:form-params request)
      (gungnir.changeset/cast :user)
      (gungnir.changeset/create [:user/password-match?])
      (gungnir.query/save!)))

(defn handler-user-registration [request]
  (if-let [errors (:errors (attempt-register-user request))]
    (-&gt; (ring/redirect "/register")
        (assoc-in [:flash :errors] errors))
    (-&gt; (ring/redirect "/")
        (assoc-in [:flash :success] "Successfully logged in."))))
</code></pre>
<h2><a href="#helpers" name="helpers"></a>Helpers</h2>
<p>Gungnir’s also provide a few helper functions for manipulating / creating changesets. These helpers can either be used on changesets or model records. Every time one of these functions are applied, all validators are re-evaluated.</p>
<ul>
  <li>gungnir.changeset/assoc</li>
  <li>gungnir.changeset/update</li>
  <li>gungnir.changeset/merge</li>
</ul>
<hr />
<div class="footer-navigation">
<span>Previous: <a href="https://kwrooijen.github.io/gungnir/model.html">model</a></span>
<span>Next: <a href="https://kwrooijen.github.io/gungnir/query.html">query</a></span>
</div></div></div></div></body></html>