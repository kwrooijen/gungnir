<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Migrations</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Gungnir</span> <span class="project-version">0.0.2-SNAPSHOT</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="README.html"><div class="inner"><span>Gungnir</span></div></a></li><li class="depth-1 "><a href="guide.html"><div class="inner"><span>Guide</span></div></a></li><li class="depth-1 "><a href="database.html"><div class="inner"><span>Database</span></div></a></li><li class="depth-1  current"><a href="migrations.html"><div class="inner"><span>Migrations</span></div></a></li><li class="depth-1 "><a href="model.html"><div class="inner"><span>Model</span></div></a></li><li class="depth-1 "><a href="changeset.html"><div class="inner"><span>Changeset</span></div></a></li><li class="depth-1 "><a href="query.html"><div class="inner"><span>Query</span></div></a></li><li class="depth-1 "><a href="transactions.html"><div class="inner"><span>Transactions</span></div></a></li><li class="depth-1 "><a href="ui.html"><div class="inner"><span>UI</span></div></a></li><li class="depth-1 "><a href="form.html"><div class="inner"><span>Form</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>gungnir</span></div></div></li><li class="depth-2 branch"><a href="gungnir.changeset.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>changeset</span></div></a></li><li class="depth-2"><a href="gungnir.database.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>database</span></div></a></li><li class="depth-3"><a href="gungnir.database.builder.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>builder</span></div></a></li><li class="depth-2 branch"><a href="gungnir.decode.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>decode</span></div></a></li><li class="depth-2 branch"><a href="gungnir.factory.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>factory</span></div></a></li><li class="depth-2 branch"><a href="gungnir.field.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>field</span></div></a></li><li class="depth-2 branch"><a href="gungnir.migration.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>migration</span></div></a></li><li class="depth-2 branch"><a href="gungnir.model.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>model</span></div></a></li><li class="depth-2 branch"><a href="gungnir.query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>query</span></div></a></li><li class="depth-2 branch"><a href="gungnir.record.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>record</span></div></a></li><li class="depth-2 branch"><a href="gungnir.spec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>spec</span></div></a></li><li class="depth-2 branch"><a href="gungnir.transaction.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>transaction</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></div></li><li class="depth-3"><a href="gungnir.util.malli.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>malli</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#migrations" id="migrations"></a>Migrations</h1>
<p>Migrations are defined using data in EDN files. They are based on the <a href="https://github.com/weavejester/ragtime">Ragtime</a> format and 100% backwards compatible. So you can choose to use raw SQL if you prefer. Every migration file contains a map with an <code>:up</code> and <code>:down</code> key. These keys contain a vector of SQL statements.</p>
<h2><a href="#creating-a-table" id="creating-a-table"></a>Creating a table</h2>
<h3><a href="#raw-sql" id="raw-sql"></a>Raw SQL</h3>
<p>If you want to use raw SQL you can use the same format that Ragtime uses. You can add multiple statements in the <code>:up</code> and <code>:down</code> keys to run multiple SQL commands.</p>
<pre><code class="language-clojure">;; resources/migrations/000-products.edn
{:up ["CREATE TABLE products
      ( id BIGSERIAL PRIMARY KEY
      , name TEXT NOT NULL UNIQUE
      , visible BOOLEAN NOT NULL DEFAULT false
      , created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
      , updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
      );"]
 :down ["DROP TABLE products"]}
</code></pre>
<h3><a href="#clojure-data" id="clojure-data"></a>Clojure Data</h3>
<p>You can use Clojure datastructures to define your migrations. The format is similar to how Malli defines maps. Generally a vector where the first value is a <code>qualified-keyword</code>, second value is optionally a map with options, and then a finite amount of values.</p>
<p>We can recreate the same statement with the following data:</p>
<pre><code class="language-clojure">;; resources/migrations/000-products.edn
{:up [[:table/create {:table :products}
       [:column/add
        [:id {:primary-key true} :bigserial]
        [:name {:unique true} :string]
        [:visible {:default false} :boolean]
        [:created-at {:default :current-timestamp} :timestamp]
        [:updated-at {:default :current-timestamp} :timestamp]]]]
 :down [[:table/drop :products]]}
</code></pre>
<p>We use the <code>:table/create</code> key to create a new table and define the name using the <code>:table</code> key in the options map. The following values are actions. The <code>:column/add</code> action allows us to add all the columns we need with type and additional options.</p>
<p>If no primary-key is defined in our migration, Gungnir will by default automatically add an <code>id</code> column the the <code>BIGSERIAL</code> type as a primary-key. Gungnir also provides a special column action called <code>:gungnir/timestamps</code> which adds a <code>created_at</code> and <code>updated_at</code> column. We can rewrite our previous migration to the following:</p>
<pre><code class="language-clojure">;; resources/migrations/000-products.edn
{:up [[:table/create {:table :products}
       [:column/add
        [:name {:unique true} :string]
        [:visible {:default false} :boolean]
        [:gungnir/timestamps]]]]
 :down [[:table/drop :products]]}
</code></pre>
<h2><a href="#extending" id="extending"></a>Extending</h2>
<p>Sometimes you might need more control for your migrations. For example you might want to add data to your database, generated with Clojure. Or Gungnir is missing a migration feature that should be implemented in a data-driven action (In that case, feel free to open a pull request!).</p>
<p>To create your own migration action, you need to implement the <code>gungnir.migration/format-action</code> multimethod. It matches on a qualified-keyword representing the action, the first value of the vector. The second value of the vector is an optional map. The rest of the values is just a collection of input. The return value of this multimethod should be a string representing a raw SQL query.</p>
<pre><code class="language-clojure">;; 001-some-migration.edn

{:up [[:my/migration-action
       {:some-option 123}
       [:my/field 1]
       [:my/field 2]
       [:my/field 3]]]

 :down [[:my/migration-reverse 1 2 3]]}

;; my-app/core.clj
(defmethod format-action :my/migration-action [[_key opts &amp; fields]]
  ;; _key   : :my/migration-action
  ;; opts   : {:some-option 123}
  ;; fields : '([:my/field 1] [:my/field 2] [:my/field 3])
  ;;
  ;; Implement your query
  "INSERT INTO account ...")

(defmethod format-action :my/migration-reverse [[_key opts &amp; fields]]
  ;; _key   : :my/migration-reverse
  ;; opts   : {}
  ;; fields : '(1 2 3)
  ;;
  ;; Implement your query
  "DELETE from account ...")
</code></pre>
<h2><a href="#keys" id="keys"></a>Keys</h2>
<h3><a href="#table" id="table"></a>Table</h3>
<table>
<thead>
<tr><th> key             </th><th> description             </th></tr>
</thead>
<tbody>
<tr><td> <code>:table/create</code> </td><td> Create a new table      </td></tr>
<tr><td> <code>:table/alter</code>  </td><td> Alter an existing table </td></tr>
<tr><td> <code>:table/drop</code>   </td><td> Drop an existing table  </td></tr>
</tbody>
</table>
<h3><a href="#table-options" id="table-options"></a>Table options</h3>
<table>
<thead>
<tr><th> key            </th><th> description                                                                                          </th></tr>
</thead>
<tbody>
<tr><td> <code>:table</code>       </td><td> Table name to create or alter                                                                        </td></tr>
<tr><td> <code>:primary-key</code> </td><td> Set to <code>false</code> to disable automatic primary-key generation. Set to <code>:uuid</code> use a uuid as primary-key </td></tr>
</tbody>
</table>
<h3><a href="#column" id="column"></a>Column</h3>
<table>
<thead>
<tr><th> key            </th><th> description             </th></tr>
</thead>
<tbody>
<tr><td> <code>:column/add</code>  </td><td> Create a new table      </td></tr>
<tr><td> <code>:column/drop</code> </td><td> Alter an existing table </td></tr>
</tbody>
</table>
<h3><a href="#column-types" id="column-types"></a>Column types</h3>
<table>
<thead>
<tr><th> key          </th><th> postgres type                       </th></tr>
</thead>
<tbody>
<tr><td> <code>:string</code>    </td><td> TEXT or VARCHAR(:size)              </td></tr>
<tr><td> <code>:int</code>       </td><td> INTEGER                             </td></tr>
<tr><td> <code>:float</code>     </td><td> FLOAT(:size) (:size default 8)      </td></tr>
<tr><td> <code>:boolean</code>   </td><td> BOOLEAN                             </td></tr>
<tr><td> <code>:serial</code>    </td><td> SERIAL                              </td></tr>
<tr><td> <code>:bigserial</code> </td><td> BIGSERIAL                           </td></tr>
<tr><td> <code>:timestamp</code> </td><td> TIMESTAMP                           </td></tr>
<tr><td> <code>:uuid</code>      </td><td> UUID (requires uuid-ossp extension) </td></tr>
</tbody>
</table>
<h3><a href="#column-type-options" id="column-type-options"></a>Column type options</h3>
<table>
<thead>
<tr><th> key            </th><th> description                                                                          </th></tr>
</thead>
<tbody>
<tr><td> <code>:primary-key</code> </td><td> Makes column primary key                                                             </td></tr>
<tr><td> <code>:size</code>        </td><td> Sets the size of the value (:string / :float)                                        </td></tr>
<tr><td> <code>:default</code>     </td><td> Set the default value on creation                                                    </td></tr>
<tr><td> <code>:optional</code>    </td><td> Make a column optional. By default every column is required                          </td></tr>
<tr><td> <code>:unique</code>      </td><td> Column should be unique                                                              </td></tr>
<tr><td> <code>:references</code>  </td><td> Column is a foreign referencing a :table/column (qualified keyword e.g. :account/id) </td></tr>
</tbody>
</table>
<h2><a href="#running-migrations" id="running-migrations"></a>Running migrations</h2>
<p>For convenience you can add the Ragtime configuration in your <code>user.clj</code>. This will allow you to access it whenever you enter the REPL in the user namespace.</p>
<pre><code class="language-clojure">(ns user
  (:require 
    [gungnir.migration]))

(def migrations (gungnir.migration/load-resources "migrations"))
</code></pre>
<p>Enter the REPL (e.g. <code>lein repl</code>). Require the <code>gungnir.migration</code> namespace and run the migrations using the <code>gungnir.migration/migrate!</code> function. All pending migrations will be executed.</p>
<pre><code class="language-clojure">user=&gt; (require '[gungnir.migration :as migration])
nil
user=&gt; (migration/migrate! migrations)
Applying 000-uuid
Applying 001-auto-updated-at
Applying 002-account
</code></pre>
<p>You can also rollback migrations one by one using the <code>gungnir.migration/rollback!</code> function.</p>
<pre><code class="language-clojure">nil
user=&gt; (migration/rollback! config)
Rolling back 002-account
nil
user=&gt; (migration/rollback! config)
Rolling back 001-auto-updated-at
nil
user=&gt; (migration/rollback! config)
Rolling back 000-uuid
nil
</code></pre>
<hr />
<div class="footer-navigation">
<span>Previous: <a href="https://kwrooijen.github.io/gungnir/database.html">database</a></span>
<span>Next: <a href="https://kwrooijen.github.io/gungnir/model.html">model</a></span>
</div>
</div></div></div></body></html>