<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Query</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Gungnir</span> <span class="project-version">0.0.2-SNAPSHOT</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="README.html"><div class="inner"><span>Gungnir</span></div></a></li><li class="depth-1 "><a href="guide.html"><div class="inner"><span>Guide</span></div></a></li><li class="depth-1 "><a href="database.html"><div class="inner"><span>Database</span></div></a></li><li class="depth-1 "><a href="migrations.html"><div class="inner"><span>Migrations</span></div></a></li><li class="depth-1 "><a href="model.html"><div class="inner"><span>Model</span></div></a></li><li class="depth-1 "><a href="changeset.html"><div class="inner"><span>Changeset</span></div></a></li><li class="depth-1  current"><a href="query.html"><div class="inner"><span>Query</span></div></a></li><li class="depth-1 "><a href="transactions.html"><div class="inner"><span>Transactions</span></div></a></li><li class="depth-1 "><a href="ui.html"><div class="inner"><span>UI</span></div></a></li><li class="depth-1 "><a href="form.html"><div class="inner"><span>Form</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>gungnir</span></div></div></li><li class="depth-2 branch"><a href="gungnir.changeset.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>changeset</span></div></a></li><li class="depth-2"><a href="gungnir.database.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>database</span></div></a></li><li class="depth-3"><a href="gungnir.database.builder.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>builder</span></div></a></li><li class="depth-2 branch"><a href="gungnir.decode.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>decode</span></div></a></li><li class="depth-2 branch"><a href="gungnir.factory.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>factory</span></div></a></li><li class="depth-2 branch"><a href="gungnir.field.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>field</span></div></a></li><li class="depth-2 branch"><a href="gungnir.migration.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>migration</span></div></a></li><li class="depth-2 branch"><a href="gungnir.model.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>model</span></div></a></li><li class="depth-2 branch"><a href="gungnir.query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>query</span></div></a></li><li class="depth-2 branch"><a href="gungnir.record.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>record</span></div></a></li><li class="depth-2 branch"><a href="gungnir.spec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>spec</span></div></a></li><li class="depth-2 branch"><a href="gungnir.transaction.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>transaction</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></div></li><li class="depth-3"><a href="gungnir.util.malli.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>malli</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#query" id="query"></a>Query</h1>
<p>Gungnir provides an API for querying data based on your models. This API is based on 3 functions. All of these functions are extendable with HoneySQL, and you can also fall back to HoneySQL completely if necessary. Making Gungnir very flexible. Additionally there’s a convenience method to querying relations.</p>
<ul>
<li>
<p><code>gungnir.query/find-by!</code> - Find a single record based on key value matches or return <code>nil</code>.</p>
</li>
<li>
<p><code>gungnir.query/find!</code> - Find a single record based on a primary-key or return <code>nil</code>.</p>
</li>
<li>
<p><code>gungnir.query/all!</code> - Find a collection of records based on key value matches or return an empty vector.</p>
</li>
</ul>
<h2><a href="#gungnirqueryfind-by" id="gungnirqueryfind-by"></a>gungnir.query/find-by!</h2>
<p>Run a query and return a single record or nil, based on matching keys and values.</p>
<pre><code class="language-clojure">(find-by! :account/email "account@test.com"
          :account/validated true)
</code></pre>
<p>Optionally extend the queries using HoneySQL. <code>gungnir.query</code> aliases the HoneySQL helper functions, so you don’t have to require that separately.</p>
<pre><code class="language-clojure">(-&gt; (select :account/accountname)
    (find-by! :account/email "account@test.com"
              :account/validated true))
</code></pre>
<h2><a href="#gungnirqueryfind" id="gungnirqueryfind"></a>gungnir.query/find!</h2>
<p>Run a query and return a single record or nil.</p>
<p>Depending on the types of arguments provided, <code>find!</code> will have different behaviors.</p>
<h3><a href="#arity-1" id="arity-1"></a>Arity 1</h3>
<p>Use <code>form</code> to query the database and return a single record or nil. Will not find a record by it’s primary-key.</p>
<p><code>form</code> - HoneySQL form which will be used to query the database.</p>
<pre><code class="language-clojure">(-&gt; (select :*)
    (from :account)
    (where [:= :account/id account-id])
    (find!))
</code></pre>
<h3><a href="#arity-2" id="arity-2"></a>Arity 2</h3>
<p>Find a record by it’s primary-key from the table represented by the <code>model-key</code>.</p>
<p><code>model-key</code> - Model key which will identify which table to read from.</p>
<p><code>primary-key-value</code> - The value of the primary key to match with.</p>
<pre><code class="language-clojure">(find! :account account-id)
</code></pre>
<h3><a href="#arity-3" id="arity-3"></a>Arity 3</h3>
<p>Find a record by it’s primary-key from the table represented by the <code>model-key</code>. Extended with the HoneySQL <code>form</code>.</p>
<p><code>form</code> - HoneySQL form which will be used to query the database.</p>
<p><code>model-key</code> - Model key which will identify which table to read from.</p>
<p><code>primary-key-value</code> - The value of the primary key to match with.</p>
<p>Find a single record by its <code>primary-key-value</code> from <code>table</code>. Optionally extend the query using a HoneySQL <code>form</code>."</p>
<pre><code class="language-clojure">(-&gt; (select :account/email)
    (where [:= :account/active false])
    (find! :account account-id))
</code></pre>
<hr />
<h2><a href="#gungnirqueryall" id="gungnirqueryall"></a>gungnir.query/all!</h2>
<p>Run a query and return a collection of records.</p>
<p>Depending on the types of arguments provided, <code>all!</code> will have different behaviors.</p>
<h3><a href="#arity-1" id="arity-1"></a>Arity 1</h3>
<p><code>?table</code> - either a <code>simple-keyword</code> representing a Gungnir which will return all rows of that table. Or it a <code>HoneySQL</code> form query the database using that.</p>
<pre><code class="language-clojure">(all! :account)

(-&gt; (select :*)
    (from :account)
    (all!))
</code></pre>
<h3><a href="#arity-2" id="arity-2"></a>Arity 2</h3>
<p><code>?form</code> - either a <code>HoneySQL</code> form which will extend the query. Or a <code>qualified-keyword</code> representing a model field.</p>
<p><code>args</code> - a collection of keys and values. Where the keys are <code>qualified-keywords</code> representing a model fields which will be matched with the values. If no key value pairs are provided then you must supply a model name as a <code>simple-keyword</code>.</p>
<pre><code class="language-clojure">(all! :account/validated false
      :account/type :account/pro)

(-&gt; (where [:&gt; :account/date expiration-date])
    (limit 30)
    (all! :account))
</code></pre>
<hr />
<h2><a href="#querying-relations" id="querying-relations"></a>Querying Relations</h2>
<p>Gungnir provides an atom for accessing relations. If you’ve defined relations in the <a href="https://kwrooijen.github.io/gungnir/model.html">model</a> these atoms will become available when you query records.</p>
<h3><a href="#relation-atom" id="relation-atom"></a>Relation atom</h3>
<p>The way these atoms work is you don’t query the relations immediately. Instead the query will only be executed once you <code>deref</code> the atom. Additionally you can modify the query this atom will execute beforehand by using <code>swap!</code> and any <code>HoneySQL</code> formatting function.</p>
<h3><a href="#relation-atom-deref" id="relation-atom-deref"></a>Relation atom - deref</h3>
<p>A very simple example would be to find a account by their email. If in the <code>:account</code> model has a <code>has-many</code> posts definition:</p>
<pre><code class="language-clojure">{:has-many {:account/posts {model :post :foreign-key :post/account-id}}}

;; NOTE: If no `:foreign-key` is provided, Gungnir will fill it in. As long as
;; the column has the form `{model}-id` it will work. When the column name is
;; not the same as the model name (e.g. `author-id` for the account model) you'll
;; have to specify it yourself.

{:has-many {:account/posts {model :post}}}
</code></pre>
<p>You’ll be able to query a account’s posts:</p>
<pre><code class="language-clojure">(-&gt; (q/find-by! :account/email "account@test.com")
    :account/posts
    (deref)) ;; Query all posts belong to the account "account@test.com"
</code></pre>
<p>If posts also have many comments, you can deref those relations as well simply by following the path.</p>
<pre><code class="language-clojure">(-&gt; (q/find-by! :account/email "account@test.com")
    :account/posts
    (deref)
    (first)
    :post/comments
    (deref)) ;; Results in the first post's comments
</code></pre>
<p>Relations are a two way street, technically speaking you could go back to the origin record using <code>deref</code>.</p>
<pre><code class="language-clojure">(-&gt; (q/find-by! :account/email "account@test.com")
    :account/posts
    (deref)
    (first)
    :post/account
    (deref)) ;; Back to the origin account record
</code></pre>
<h3><a href="#relation-atom-swap" id="relation-atom-swap"></a>Relation atom - swap!</h3>
<p>If we don’t want all the account’s posts, but only their top five, you can modify the atom with <code>swap!</code> before executing <code>deref</code>.</p>
<pre><code class="language-clojure">(-&gt; (q/find-by! :account/email "account@test.com")
    :account/posts
    (swap! q/limit 5)
    (swap! q/order-by [:post/score :desc])
    (deref))
</code></pre>
<h3><a href="#gungnirqueryload" id="gungnirqueryload"></a>gungnir.query/load!</h3>
<p>Another helper function provided by Gungnir is the <code>gungnir.query/load!</code> function. This allows you to deref relations in a record without having to remove them from the record itself.</p>
<pre><code class="language-clojure">(-&gt; (q/find-by! :account/email "account@test.com")
    (q/load! :account/posts :account/comments))

;; =&gt; #:account{:id #uuid ",,,"
;; =&gt;           :posts [#:post{,,,}
;; =&gt;                   ,,,]
;; =&gt;           :comments [#:comment{,,,}
;; =&gt;                      ,,,]}
</code></pre>
<p>Combined with this you can use the <code>update</code> core function to modify the atoms before loading.</p>
<pre><code class="language-clojure">(-&gt; (q/find-by! :account/email "account@test.com")
    (update :account/posts q/limit 1)
    (update :account/comment q/limit 1)
    (q/load! :account/posts :account/comments))

;; Notice only 1 element in the vectors
;; =&gt; #:account{:id #uuid ",,,"
;; =&gt;           :posts [#:post{,,,}]
;; =&gt;           :comments [#:comment{,,,}]
</code></pre>
<hr />
<div class="footer-navigation">
<span>Previous: <a href="https://kwrooijen.github.io/gungnir/changeset.html">changeset</a></span>
<span>Next: <a href="https://kwrooijen.github.io/gungnir/transactions.html">transaction</a></span>
</div>
</div></div></div></body></html>