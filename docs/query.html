<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Query</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Gungnir</span> <span class="project-version">0.0.1-SNAPSHOT</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="README.html"><div class="inner"><span>Gungnir</span></div></a></li><li class="depth-1 "><a href="guide.html"><div class="inner"><span>Guide</span></div></a></li><li class="depth-1 "><a href="database.html"><div class="inner"><span>Database</span></div></a></li><li class="depth-1 "><a href="migrations.html"><div class="inner"><span>Migrations</span></div></a></li><li class="depth-1 "><a href="model.html"><div class="inner"><span>Model</span></div></a></li><li class="depth-1 "><a href="changeset.html"><div class="inner"><span>Changeset</span></div></a></li><li class="depth-1  current"><a href="query.html"><div class="inner"><span>Query</span></div></a></li><li class="depth-1 "><a href="ui.html"><div class="inner"><span>UI</span></div></a></li><li class="depth-1 "><a href="form.html"><div class="inner"><span>Form</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>gungnir</span></div></div></li><li class="depth-2 branch"><a href="gungnir.changeset.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>changeset</span></div></a></li><li class="depth-2"><a href="gungnir.database.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>database</span></div></a></li><li class="depth-3"><a href="gungnir.database.builder.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>builder</span></div></a></li><li class="depth-2 branch"><a href="gungnir.decode.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>decode</span></div></a></li><li class="depth-2 branch"><a href="gungnir.factory.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>factory</span></div></a></li><li class="depth-2 branch"><a href="gungnir.field.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>field</span></div></a></li><li class="depth-2 branch"><a href="gungnir.model.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>model</span></div></a></li><li class="depth-2 branch"><a href="gungnir.query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>query</span></div></a></li><li class="depth-2 branch"><a href="gungnir.record.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>record</span></div></a></li><li class="depth-2 branch"><a href="gungnir.spec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>spec</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></div></li><li class="depth-3"><a href="gungnir.util.malli.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>malli</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#query" name="query"></a>Query</h1>
<p>Gungnir provides an API for querying data based on your models. This API is based on 3 functions. All of these functions are extendable with HoneySQL, and you can also fall back to HoneySQL completely if necessary. Making Gungnir very flexible. Additionally there’s a convenience method to querying relations.</p>
<ul>
  <li>
  <p><code>gungnir.query/find-by!</code> - Find a single record based on key value matches or  return <code>nil</code>.</p></li>
  <li>
  <p><code>gungnir.query/find!</code> - Find a single record based on a primary-key or return  <code>nil</code>.</p></li>
  <li>
  <p><code>gungnir.query/all!</code> - Find a collection of records based on key value matches  or return an empty vector.</p></li>
</ul>
<h2><a href="#gungnir-query-find-by-" name="gungnir-query-find-by-"></a>gungnir.query/find-by!</h2>
<p>Run a query and return a single record or nil, based on matching keys and values.</p>
<pre><code class="clojure">(find-by! :user/email "user@test.com"
          :user/validated true)
</code></pre>
<p>Optionally extend the queries using HoneySQL. <code>gungnir.query</code> aliases the HoneySQL helper functions, so you don’t have to require that separately.</p>
<pre><code class="clojure">(-&gt; (select :user/username)
    (find-by! :user/email "user@test.com"
              :user/validated true))
</code></pre>
<h2><a href="#gungnir-query-find-" name="gungnir-query-find-"></a>gungnir.query/find!</h2>
<p>Run a query and return a single record or nil.</p>
<p>Depending on the types of arguments provided, <code>find!</code> will have different behaviors.</p>
<h3><a href="#arity-1" name="arity-1"></a>Arity 1</h3>
<p>Use <code>form</code> to query the database and return a single record or nil. Will not find a record by it’s primary-key.</p>
<p><code>form</code> - HoneySQL form which will be used to query the database.</p>
<pre><code class="clojure">(-&gt; (select :*)
    (from :user)
    (where [:= :user/id user-id])
    (find!))
</code></pre>
<h3><a href="#arity-2" name="arity-2"></a>Arity 2</h3>
<p>Find a record by it’s primary-key from the table represented by the <code>model-key</code>.</p>
<p><code>model-key</code> - Model key which will identify which table to read from.</p>
<p><code>primary-key-value</code> - The value of the primary key to match with.</p>
<pre><code class="clojure">(find! :user user-id)
</code></pre>
<h3><a href="#arity-3" name="arity-3"></a>Arity 3</h3>
<p>Find a record by it’s primary-key from the table represented by the <code>model-key</code>. Extended with the HoneySQL <code>form</code>.</p>
<p><code>form</code> - HoneySQL form which will be used to query the database.</p>
<p><code>model-key</code> - Model key which will identify which table to read from.</p>
<p><code>primary-key-value</code> - The value of the primary key to match with.</p>
<p>Find a single record by its <code>primary-key-value</code> from <code>table</code>. Optionally extend the query using a HoneySQL <code>form</code>."</p>
<pre><code class="clojure">(-&gt; (select :user/email)
    (where [:= :user/active false])
    (find! :user user-id))
</code></pre>
<hr />
<h2><a href="#gungnir-query-all-" name="gungnir-query-all-"></a>gungnir.query/all!</h2>
<p>Run a query and return a collection of records.</p>
<p>Depending on the types of arguments provided, <code>all!</code> will have different behaviors.</p>
<h3><a href="#arity-1" name="arity-1"></a>Arity 1</h3>
<p><code>?table</code> - either a <code>simple-keyword</code> representing a Gungnir which will return all rows of that table. Or it a <code>HoneySQL</code> form query the database using that.</p>
<pre><code class="clojure">(all! :user)

(-&gt; (select :*)
    (from :user)
    (all!))
</code></pre>
<h3><a href="#arity-2" name="arity-2"></a>Arity 2</h3>
<p><code>?form</code> - either a <code>HoneySQL</code> form which will extend the query. Or a <code>qualified-keyword</code> representing a model field.</p>
<p><code>args</code> - a collection of keys and values. Where the keys are <code>qualified-keywords</code> representing a model fields which will be matched with the values. If no key value pairs are provided then you must supply a model name as a <code>simple-keyword</code>.</p>
<pre><code class="clojure">(all! :user/validated false
      :user/type :user/pro)

(-&gt; (where [:&gt; :user/date expiration-date])
    (limit 30)
    (all! :user))
</code></pre>
<hr />
<h2><a href="#querying-relations" name="querying-relations"></a>Querying Relations</h2>
<p>Gungnir provides an atom for accessing relations. If you’ve defined relations in the <a href="https://kwrooijen.github.io/gungnir/model.html">model</a> these atoms will become available when you query records.</p>
<h3><a href="#relation-atom" name="relation-atom"></a>Relation atom</h3>
<p>The way these atoms work is you don’t query the relations immediately. Instead the query will only be executed once you <code>deref</code> the atom. Additionally you can modify the query this atom will execute beforehand by using <code>swap!</code> and any <code>HoneySQL</code> formatting function.</p>
<h3><a href="#relation-atom-deref" name="relation-atom-deref"></a>Relation atom - deref</h3>
<p>A very simple example would be to find a user by their email. If in the <code>:user</code> model has a <code>has-many</code> posts definition:</p>
<pre><code class="clojure">{:has-many {:user/posts {model :post :through :post/user-id}}}
</code></pre>
<p>You’ll be able to query a user’s posts:</p>
<pre><code class="clojure">(-&gt; (q/find-by! :user/email "user@test.com")
    :user/posts
    (deref)) ;; Query all posts belong to the user "user@test.com"
</code></pre>
<p>If posts also have many comments, you can deref those relations as well simply by following the path.</p>
<pre><code class="clojure">(-&gt; (q/find-by! :user/email "user@test.com")
    :user/posts
    (deref)
    (first)
    :post/comments
    (deref)) ;; Results in the first post's comments
</code></pre>
<p>Relations are a two way street, technically speaking you could go back to the origin record using <code>deref</code>.</p>
<pre><code class="clojure">(-&gt; (q/find-by! :user/email "user@test.com")
    :user/posts
    (deref)
    (first)
    :post/user
    (deref)) ;; Back to the origin user record
</code></pre>
<h3><a href="#relation-atom-swap-" name="relation-atom-swap-"></a>Relation atom - swap!</h3>
<p>If we don’t want all the user’s posts, but only their top five, you can modify the atom with <code>swap!</code> before executing <code>deref</code>.</p>
<pre><code class="clojure">(-&gt; (q/find-by! :user/email "user@test.com")
    :user/posts
    (swap! q/limit 5)
    (swap! q/order-by [:post/score :desc])
    (deref))
</code></pre>
<h3><a href="#gungnir-query-load-" name="gungnir-query-load-"></a>gungnir.query/load!</h3>
<p>Another helper function provided by Gungnir is the <code>gungnir.query/load!</code> function. This allows you to deref relations in a record without having to remove them from the record itself.</p>
<pre><code class="clojure">(-&gt; (q/find-by! :user/email "user@test.com")
    (q/load! :user/posts :user/comments))

;; =&gt; #:user{:id #uuid ",,,"
;; =&gt;        :posts [#:post{,,,}
;; =&gt;                ,,,]
;; =&gt;        :comments [#:comment{,,,}
;; =&gt;                   ,,,]}
</code></pre>
<p>Combined with this you can use the <code>update</code> core function to modify the atoms before loading.</p>
<pre><code class="clojure">(-&gt; (q/find-by! :user/email "user@test.com")
    (update :user/posts q/limit 1)
    (update :user/comment q/limit 1)
    (q/load! :user/posts :user/comments))

;; Notice only 1 element in the vectors
;; =&gt; #:user{:id #uuid ",,,"
;; =&gt;        :posts [#:post{,,,}]
;; =&gt;        :comments [#:comment{,,,}]
</code></pre>
<hr />
<div class="footer-navigation">
<span>Previous: <a href="https://kwrooijen.github.io/gungnir/changeset.html">changeset</a></span>
<span>Next: <a href="https://kwrooijen.github.io/gungnir/ui.html">UI</a></span>
</div></div></div></div></body></html>